default_platform(:android)

platform :android do
  ############################################################
  # üîß CONFIG
  ############################################################
  PACKAGE_NAMES = {
    "local" => "com.fldp.mobile_app.local",
    "dev"   => "com.fldp.mobile_app.dev",
    "prod"  => "com.fldp.mobile_app"
  }

  TRACKS = {
    "local" => "beta",
    "dev"   => "beta",
    "prod"  => "production"
  }

  JSON_KEYS = {
    "dev"   => "../service-account-google-for-upload/service-account-dev.json",
    "prod"  => "../service-account-google-for-upload/service-account-prod.json"
  }

  DEFAULT_TARGET_FILE  = "lib/main.dart" # ‡∏ï‡∏≤‡∏° launch.json ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
  CHANGELOGS_DIR       = "fastlane/changelogs" # ‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ä‡πà‡∏ô fastlane/changelogs/dev.txt

  ############################################################
  # üîé Helpers
  ############################################################
def find_aab_path(flavor)
  candidates = Dir[
    "../../build/app/outputs/bundle/#{flavor}Release/*.aab",
    "../app/build/outputs/bundle/#{flavor}Release/*.aab",
    "build/app/outputs/bundle/#{flavor}Release/*.aab",
    "app/build/outputs/bundle/#{flavor}Release/*.aab"
  ].flatten.compact

  UI.message("üìÇ CWD: #{Dir.pwd}")
  UI.message("üîç Found AABs: #{candidates}") unless candidates.empty?
  UI.user_error!("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå AAB ‡πÉ‡∏ô paths ‡∏ó‡∏µ‡πà‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤") if candidates.empty?

  # >>> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô absolute path
  File.expand_path(candidates.max_by { |f| File.mtime(f) })
end

  def load_changelog(flavor)
    # ‡∏≠‡πà‡∏≤‡∏ô changelog ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå ‡πÄ‡∏ä‡πà‡∏ô fastlane/changelogs/dev.txt
    path = File.join(CHANGELOGS_DIR, "#{flavor}.txt")
    File.exist?(path) ? File.read(path) : nil
  end

  ############################################################
  # üèóÔ∏è BUILD AAB (Flutter + FVM)
  ############################################################
  desc "Build Flutter AAB ‡∏ï‡∏≤‡∏° flavor"
  lane :build_flutter do |options|
    flavor      = (options[:flavor] || "dev").downcase
    target_file = options[:target] || DEFAULT_TARGET_FILE
    dart_define = options[:dart_define] || "flavor=#{flavor}"
    build_num   = options[:build_number] # ‡πÉ‡∏™‡πà‡∏à‡∏≤‡∏Å CI ‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô build_number: ENV['BUILD_NUMBER']

    sh "fvm flutter --version"
    # ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö clean ‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏õ (‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô) ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å clean, ‡∏õ‡∏•‡∏î‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á
    # sh "fvm flutter clean"
    sh "fvm flutter pub get"

    cmd = [
      "fvm flutter build appbundle --release",
      "--flavor #{flavor}",
      "--dart-define=#{dart_define}",
      "-t #{target_file}",
      "-v"
    ]
    cmd << "--build-number #{build_num}" if build_num # ‡∏Ñ‡∏∏‡∏° versionCode ‡∏à‡∏≤‡∏Å CI ‡πÑ‡∏î‡πâ
    sh cmd.join(" ")

    aab_path = find_aab_path(flavor)
    UI.message("‚úÖ AAB: #{aab_path}")

    Actions.lane_context[:AAB_PATH] = aab_path
    Actions.lane_context[:FLAVOR]   = flavor
  end

  ############################################################
  # üöÄ UPLOAD AAB ‚Üí GOOGLE PLAY
  ############################################################
  desc "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î AAB ‡πÑ‡∏õ Google Play ‡∏ï‡∏≤‡∏° flavor (override track ‡πÑ‡∏î‡πâ)"
  lane :upload_playstore do |options|
  flavor = (options[:flavor] || Actions.lane_context[:FLAVOR] || "dev").downcase
  aab    = options[:aab] || Actions.lane_context[:AAB_PATH]

  aab = File.expand_path(aab)
  json_key_path = ENV["GOOGLE_PLAY_JSON"] || File.expand_path(JSON_KEYS[flavor] || JSON_KEYS["dev"])

  UI.user_error!("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå AAB ‡∏ó‡∏µ‡πà #{aab}") unless File.exist?(aab)
  package = PACKAGE_NAMES[flavor] or UI.user_error!("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πá‡∏û PACKAGE_NAMES ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö flavor=#{flavor}")
  track   = (options[:track] || TRACKS[flavor])

  UI.message("üè∑Ô∏è Flavor: #{flavor}")
  UI.message("üì¶ Package: #{package}")
  UI.message("üõ§Ô∏è Track: #{track}")
  UI.message("üìÅ AAB: #{aab}")
  UI.message("üîë JSON Key: #{json_key_path}")

  # ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡∏™‡πà‡∏á 'changelog:' ‡∏´‡∏£‡∏∑‡∏≠ 'changelogs:' ‡∏ñ‡πâ‡∏≤ fastlane ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
supply(
  aab: aab,
  json_key: json_key_path,
  package_name: package,
  track: track,
  release_status: "draft",      # üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  skip_upload_images: true,
  skip_upload_screenshots: true,
  skip_upload_metadata: true,
  skip_upload_changelogs: false
)
end

  ############################################################
  # ‚öôÔ∏è DEPLOY (Build + Upload)
  ############################################################
  desc "Build ‡πÅ‡∏•‡∏∞ Upload Google Play (‡∏£‡∏∞‡∏ö‡∏∏ flavor) (override track/target/build_number ‡πÑ‡∏î‡πâ)"
  lane :deploy do |options|
    flavor = (options[:flavor] || "dev").downcase

    build_flutter(
      flavor: flavor,
      target: options[:target],           # ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å -t ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡πá‡∏™‡πà‡∏á‡∏°‡∏≤
      dart_define: options[:dart_define], # ‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô API_URL=...
      build_number: options[:build_number]
    )

    upload_playstore(
      flavor: flavor,
      track: options[:track] # ‡∏≠‡∏¢‡∏≤‡∏Å‡∏õ‡∏•‡πà‡∏≠‡∏¢ dev ‚Üí closed ‡∏Å‡πá‡∏ó‡∏≥‡πÑ‡∏î‡πâ: fastlane deploy flavor:dev track:closed
    )
  end
end
